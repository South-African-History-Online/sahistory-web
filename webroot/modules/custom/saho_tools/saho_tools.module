<?php

/**
 * @file
 * Contains hook implementations for the SAHO Tools module.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\file\Entity\File;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\node\NodeInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;
use Drupal\Core\Entity\FieldableEntityInterface;

/**
 * Implements hook_help().
 */
function saho_tools_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.saho_tools':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The SAHO Tools module provides functionality for the Tools dropdown, including citation generation.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_page_attachments_alter().
 */
function saho_tools_page_attachments_alter(array &$attachments) {
  // Check if we're on an admin route
  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();
  
  // Only attach the citation library on non-admin routes
  if (!$is_admin) {
    $attachments['#attached']['library'][] = 'saho_tools/citation';
    
    // Add debugging information to check if the library is loaded
    $attachments['#attached']['drupalSettings']['sahoTools']['debug'] = [
      'libraryLoaded' => TRUE,
      'timestamp' => time(),
    ];
    
    // If we're on a node page, add node data
    $node = \Drupal::routeMatch()->getParameter('node');
    if ($node instanceof NodeInterface) {
      // Add node data as drupalSettings for JavaScript.
      $node_data = [
        'nid' => $node->id(),
        'title' => $node->getTitle(),
        'type' => $node->getType(),
        'created' => $node->getCreatedTime(),
        'changed' => $node->getChangedTime(),
        'url' => $node->toUrl()->setAbsolute()->toString(),
      ];
      
      // Add author information if available.
      if ($node->hasField('field_article_author') && !$node->get('field_article_author')->isEmpty()) {
        $node_data['author'] = $node->get('field_article_author')->value;
      }
      elseif ($node->getOwner()) {
        $node_data['author'] = $node->getOwner()->getDisplayName();
      }
      
      $attachments['#attached']['drupalSettings']['sahoTools']['nodeData'] = $node_data;
    }
    else {
      // For non-node pages, add basic page data
      $current_url = \Drupal::request()->getUri();
      $site_name = \Drupal::config('system.site')->get('name');
      $page_title = \Drupal::service('title_resolver')->getTitle(
        \Drupal::request(),
        \Drupal::routeMatch()->getRouteObject()
      );
      
      $page_data = [
        'title' => $page_title ?: 'Page',
        'url' => $current_url,
        'site_name' => $site_name,
      ];
      
      $attachments['#attached']['drupalSettings']['sahoTools']['pageData'] = $page_data;
    }
  }
}

/**
 * Implements hook_preprocess_html().
 */
function saho_tools_preprocess_html(&$variables) {
  // Check if we're on an admin route
  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();
  
  // Only add the citation modal container on non-admin routes
  if (!$is_admin) {
    
    // For nodes, use the canonical URL
    $node = \Drupal::routeMatch()->getParameter('node');
    if ($node instanceof NodeInterface) {
      $canonical_url = $node->toUrl('canonical')->setAbsolute()->toString();
      
      // Add canonical link to head
      $variables['#attached']['html_head'][] = [
        [
          '#type' => 'html_tag',
          '#tag' => 'link',
          '#attributes' => [
            'rel' => 'canonical',
            'href' => $canonical_url,
          ],
        ],
        'canonical_url',
      ];
    }
    
    // Add citation modal
    $variables['page_bottom']['citation_modal'] = [
      '#type' => 'html_tag',
      '#tag' => 'div',
      '#attributes' => [
        'id' => 'citation-modal',
        'class' => ['modal', 'fade'],
        'tabindex' => '-1',
        'aria-labelledby' => 'citation-modal-label',
        'aria-hidden' => 'true',
      ],
      '#value' => '<div class="modal-dialog modal-dialog-centered modal-fullscreen-md-down">
      <div class="modal-content saho-citation-modal">
        <div class="modal-header">
          <div class="d-flex align-items-center">
            <div class="modal-icon me-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-primary" viewBox="0 0 16 16">
                <path d="M12 12a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1h-1.388c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 9 7.558V11a1 1 0 0 0 1 1h2Zm-6 0a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1H4.612c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 3 7.558V11a1 1 0 0 0 1 1h2Z"/>
              </svg>
            </div>
            <h5 class="modal-title mb-0" id="citation-modal-label">Cite This Page</h5>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close citation modal"></button>
        </div>
        
        <div class="modal-body">
          <div class="citation-image-container mb-3 d-none"></div>
          
          <!-- Mobile-first stacked layout -->
          <div class="citation-formats">
            <div class="citation-format mb-4">
              <div class="citation-format-header">
                <h6 class="fw-bold text-primary mb-2">
                  <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                    <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/>
                  </svg>
                  APA (7th Edition)
                </h6>
              </div>
              <div class="citation-text-container">
                <div class="citation-text apa-citation p-3 border rounded-3">
                  <div class="citation-content mb-3">
                    <!-- Citation content will be loaded here -->
                  </div>
                  <div class="citation-actions">
                    <button type="button" class="btn btn-primary btn-sm copy-individual w-100" data-format="apa">
                      <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                      </svg>
                      Copy APA Citation
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="citation-format mb-4">
              <div class="citation-format-header">
                <h6 class="fw-bold text-primary mb-2">
                  <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                    <path d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                  </svg>
                  Harvard (Author-Date)
                </h6>
              </div>
              <div class="citation-text-container">
                <div class="citation-text harvard-citation p-3 border rounded-3">
                  <div class="citation-content mb-3">
                    <!-- Citation content will be loaded here -->
                  </div>
                  <div class="citation-actions">
                    <button type="button" class="btn btn-primary btn-sm copy-individual w-100" data-format="harvard">
                      <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                      </svg>
                      Copy Harvard Citation
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="citation-format mb-4">
              <div class="citation-format-header">
                <h6 class="fw-bold text-primary mb-2">
                  <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                    <path d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1H.5zm3.915 10L3.102 4h10.796l-1.313 7h-8.17zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                  </svg>
                  Oxford (Footnote Style)
                </h6>
              </div>
              <div class="citation-text-container">
                <div class="citation-text oxford-citation p-3 border rounded-3">
                  <div class="citation-content mb-3">
                    <!-- Citation content will be loaded here -->
                  </div>
                  <div class="citation-actions">
                    <button type="button" class="btn btn-primary btn-sm copy-individual w-100" data-format="oxford">
                      <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                      </svg>
                      Copy Oxford Citation
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <div class="d-flex flex-column flex-md-row gap-2 w-100">
            <a href="/content/referencing-resources-historical-research" 
               class="btn btn-outline-secondary" 
               target="_blank" 
               rel="noopener noreferrer">
              <svg width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
              </svg>
              Citation Help
            </a>
          </div>
        </div>
      </div>
    </div>',
    ];
    
    // Add sharing modal
    // Get the current node for description if available
    $node = \Drupal::routeMatch()->getParameter('node');
    $description = '';
    if ($node instanceof NodeInterface && $node->hasField('body') && !$node->get('body')->isEmpty()) {
      // Get a short excerpt from the body for the description
      $body_value = $node->get('body')->value;
      $description = strip_tags($body_value);
      // Limit to 150 characters
      if (strlen($description) > 150) {
        $description = substr($description, 0, 150) . '...';
      }
    }
    
    // Create a modern sharing modal
    $current_url = \Drupal::request()->getUri();
    
    // Ensure current URL is a string
    if (!is_string($current_url) || empty($current_url)) {
      $current_url = \Drupal::request()->getSchemeAndHttpHost();
    }
    $page_title = \Drupal::service('title_resolver')->getTitle(\Drupal::request(), \Drupal::routeMatch()->getRouteObject());
    
    // Ensure page title is a string
    if (is_array($page_title)) {
      // Handle nested arrays or render arrays
      if (isset($page_title['#markup'])) {
        $page_title = $page_title['#markup'];
      } elseif (isset($page_title['#plain_text'])) {
        $page_title = $page_title['#plain_text'];
      } else {
        // Flatten array, filtering out non-scalar values
        $flat_title = [];
        array_walk_recursive($page_title, function($value) use (&$flat_title) {
          if (is_scalar($value)) {
            $flat_title[] = $value;
          }
        });
        $page_title = implode(' ', $flat_title);
      }
    }
    if (is_object($page_title) && method_exists($page_title, '__toString')) {
      $page_title = (string) $page_title;
    }
    if (empty($page_title) || !is_string($page_title)) {
      $page_title = \Drupal::config('system.site')->get('name') ?: 'South African History Online';
    }
    
    // Additional safety - ensure both are strings before using in URLs
    $current_url = (string) $current_url;
    $page_title = (string) $page_title;
    
    $variables['page_bottom']['sharing_modal'] = [
      '#type' => 'html_tag',
      '#tag' => 'div',
      '#attributes' => [
        'id' => 'sharing-modal',
        'class' => ['modal', 'fade'],
        'tabindex' => '-1',
        'aria-labelledby' => 'sharing-modal-label',
        'aria-hidden' => 'true',
      ],
      '#value' => '<div class="modal-dialog modal-dialog-centered modal-fullscreen-md-down">
      <div class="modal-content saho-sharing-modal">
        <div class="modal-header">
          <h5 class="modal-title" id="sharing-modal-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
              <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>
            </svg>
            Share This Page
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close sharing modal"></button>
        </div>
        <div class="modal-body">
          <div class="url-copy-section">
            <h6>Page URL</h6>
            <div class="url-input-group">
              <input type="text" 
                     id="page-url-input" 
                     class="url-input" 
                     value="' . htmlspecialchars($current_url) . '" 
                     readonly 
                     aria-label="Page URL for sharing"
                     onclick="this.select()">
              <button type="button" 
                      class="url-copy-btn copy-url-btn" 
                      aria-label="Copy page URL to clipboard">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                  <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                </svg>
                Copy URL
              </button>
            </div>
          </div>
          
          <div class="sharing-options">
            <a href="https://www.facebook.com/sharer/sharer.php?u=' . urlencode($current_url) . '" 
               target="_blank" 
               rel="noopener noreferrer" 
               class="share-option"
               aria-label="Share on Facebook">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/>
              </svg>
              Share on Facebook
            </a>
            
            <a href="https://twitter.com/intent/tweet?url=' . urlencode($current_url) . '&text=' . urlencode($page_title) . '" 
               target="_blank" 
               rel="noopener noreferrer" 
               class="share-option"
               aria-label="Share on Twitter">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
              </svg>
              Share on Twitter
            </a>
            
            <a href="https://www.linkedin.com/sharing/share-offsite/?url=' . urlencode($current_url) . '" 
               target="_blank" 
               rel="noopener noreferrer" 
               class="share-option"
               aria-label="Share on LinkedIn">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/>
              </svg>
              Share on LinkedIn
            </a>
            
            <a href="https://api.whatsapp.com/send?text=' . urlencode($page_title . ' - ' . $current_url) . '" 
               target="_blank" 
               rel="noopener noreferrer" 
               class="share-option"
               aria-label="Share on WhatsApp">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.778-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.590-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.480 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
              </svg>
              Share on WhatsApp
            </a>
            
            <a href="mailto:?subject=' . urlencode($page_title) . '&body=' . urlencode('Check out this page: ' . $current_url) . '" 
               class="share-option"
               aria-label="Share via Email">
              <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
              </svg>
              Share via Email
            </a>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>',
      '#attached' => [
        'library' => [
          'saho_tools/sharing',
        ],
      ],
    ];
  }
}

/**
 * Implements hook_page_attachments().
 */
function saho_tools_page_attachments(array &$attachments) {
  // Check if we're on an admin route
  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();
  
  // Only add the script to modify the Cite This Page link on non-admin routes
  if (!$is_admin) {
    // Add inline script to modify the Cite This Page link to use data attribute only.
    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#value' => "
          document.addEventListener('DOMContentLoaded', function() {
            var citeLinks = document.querySelectorAll('a[href=\"#cite\"]');
            citeLinks.forEach(function(link) {
              link.setAttribute('data-citation-trigger', 'true');
              // Keep original href for SEO crawlability - don't override with javascript:void(0)
            });
          });
        ",
      ],
      'saho_tools_cite_link_modifier',
    ];
  }
}

/**
 * Implements hook_preprocess_node().
 */
function saho_tools_preprocess_node(&$variables) {
  // Add citation data to the node template.
  $node = $variables['node'];
  
  // Only proceed if we're viewing a full node.
  if ($variables['view_mode'] == 'full') {
    // Add citation data as attributes for potential use in templates.
    $variables['attributes']['data-citation-title'] = $node->getTitle();
    $variables['attributes']['data-citation-url'] = $node->toUrl()->setAbsolute()->toString();
    $variables['attributes']['data-citation-date'] = date('Y-m-d', $node->getChangedTime());
    
    // Add author information if available.
    if ($node->hasField('field_article_author') && !$node->get('field_article_author')->isEmpty()) {
      $variables['attributes']['data-citation-author'] = $node->get('field_article_author')->value;
    }
    elseif ($node->getOwner()) {
      $variables['attributes']['data-citation-author'] = $node->getOwner()->getDisplayName();
    }
    else {
      $variables['attributes']['data-citation-author'] = 'South African History Online';
    }
    
    // Add the citation button to the node template.
    $variables['citation_button'] = [
      '#theme' => 'citation_button',
      '#attributes' => [
        'class' => ['citation-button', 'btn', 'btn-sm', 'btn-outline-primary'],
        'data-citation-trigger' => 'true',
      ],
      '#title' => t('Cite This Page'),
      '#attached' => [
        'library' => ['saho_tools/citation'],
      ],
    ];
    
    // Add the sharing button to the node template.
    $variables['sharing_button'] = [
      '#theme' => 'sharing_button',
      '#attributes' => [
        'class' => ['sharing-button', 'btn', 'btn-sm', 'btn-success'],
        'data-sharing-trigger' => 'true',
      ],
      '#title' => t('Share'),
      '#attached' => [
        'library' => ['saho_tools/sharing'],
      ],
    ];
  }
}

/**
 * Implements hook_theme_suggestions_HOOK_alter() for node templates.
 */
function saho_tools_theme_suggestions_node_alter(array &$suggestions, array $variables) {
  // Add a theme suggestion for each content type.
  $node = $variables['elements']['#node'];
  $sanitized_view_mode = strtr($variables['elements']['#view_mode'], '.', '_');
  
  // Add a suggestion for the view mode and content type.
  $suggestions[] = 'node__' . $sanitized_view_mode . '__' . $node->bundle();
}

/**
 * Implements hook_metatag_tags_alter().
 */
function saho_tools_metatag_tags_alter(array &$metatags, $context) {
  // Check if context is an array and contains an entity
  if (!is_array($context) || empty($context['entity'])) {
    return;
  }
  
  // Only proceed if we have a node entity
  if ($context['entity'] instanceof NodeInterface) {
    $node = $context['entity'];
    $node_type = $node->getType();
    $image_url = '';
    
    // Define a mapping of content types to their image fields in priority order
    $type_field_map = [
      'article' => ['field_main_image', 'field_article_image', 'field_image'],
      'biography' => ['field_bio_pic'],
      'place' => ['field_place_image'],
      'archive' => ['field_archive_image', 'field_image'],
      'event' => ['field_event_image', 'field_tdih_image'],
      'image' => ['field_image'],
      'gallery_image' => ['field_gallery_image'],
      'button' => ['field_button_image'],
      'product' => ['field_product_image'],
      'upcomingevent' => ['field_upcomingevent_image'],
      'page' => ['field_image'],
    ];
    
    // Get the appropriate image field based on content type
    if (isset($type_field_map[$node_type])) {
      // Try each field in priority order
      foreach ($type_field_map[$node_type] as $field_name) {
        if ($node->hasField($field_name) && !$node->get($field_name)->isEmpty()) {
          $image_url = _saho_tools_get_image_url($node, $field_name);
          if (!empty($image_url)) {
            break; // Stop once we find a valid image
          }
        }
      }
    }
    
    // If we found an image URL, set it for all Open Graph image tags
    if (!empty($image_url)) {
      // Set the main og:image tag
      $metatags['og_image'] = $image_url;
      
      // Also set the alternative og:image:url tag
      $metatags['og_image_url'] = $image_url;
      
      // If the URL is https, also set the secure URL tag
      if (strpos($image_url, 'https://') === 0) {
        $metatags['og_image_secure_url'] = $image_url;
      }
    }
  }
}

/**
 * Helper function to get the absolute URL of an image from a node field.
 *
 * @param NodeInterface $node
 *   The node entity.
 * @param string $field_name
 *   The name of the image field.
 *
 * @return string
 *   The absolute URL of the image, or an empty string if not found.
 */
function _saho_tools_get_image_url(NodeInterface $node, string $field_name) {
  $image_url = '';
  
  // Get the file entity from the field
  $file_entity = NULL;
  
  // Cache the field value to avoid repeated method calls
  $field_value = $node->get($field_name);
  
  // Handle both entity reference fields and file fields
  if ($field_value->entity instanceof File) {
    $file_entity = $field_value->entity;
  }
  elseif ($field_value->entity instanceof FieldableEntityInterface && $field_value->entity->hasField('field_media_image')) {
    // For media entity reference fields, get the file from the media entity
    $media_entity = $field_value->entity;
    if (!$media_entity->get('field_media_image')->isEmpty()) {
      $file_entity = $media_entity->get('field_media_image')->entity;
    }
  }
  
  // Generate the absolute URL if we have a file entity
  if ($file_entity instanceof File) {
    $image_url = \Drupal::service('file_url_generator')->generateAbsoluteString($file_entity->getFileUri());
  }
  
  return $image_url;
}

/**
 * Implements hook_theme().
 */
function saho_tools_theme() {
  return [
    'citation_button' => [
      'variables' => [
        'attributes' => [],
        'title' => 'Cite This Page',
      ],
      'template' => 'citation-button',
    ],
    'sharing_button' => [
      'variables' => [
        'attributes' => [],
        'title' => 'Share',
      ],
      'template' => 'sharing-button',
    ],
    'citation_formatter_all' => [
      'variables' => [
        'citations' => NULL,
      ],
      'template' => 'citation-formatter-all',
    ],
    'citation_formatter_single' => [
      'variables' => [
        'citation' => NULL,
        'format' => NULL,
      ],
      'template' => 'citation-formatter-single',
    ],
    'node__citation' => [
      'variables' => [
        'citation_button' => NULL,
      ],
      'template' => 'node--citation',
    ],
  ];
}