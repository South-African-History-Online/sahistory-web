<?php

/**
 * @file
 * Contains hook implementations for the SAHO Tools module.
 */

use Drupal\file\Entity\File;
use Drupal\node\NodeInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Entity\FieldableEntityInterface;

/**
 * Implements hook_help().
 */
function saho_tools_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.saho_tools':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The SAHO Tools module provides functionality for the Tools dropdown, including citation generation.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_library_info_alter().
 */
function saho_tools_library_info_alter(&$libraries, $extension) {
  // Add dynamic cache busting for saho_tools libraries.
  if ($extension === 'saho_tools') {
    $module_path = \Drupal::service('extension.list.module')->getPath('saho_tools');

    // Get file modification times for cache busting - check all CSS files.
    $css_files = [
      $module_path . '/css/citation.css',
      $module_path . '/css/citation-modern.css',
      $module_path . '/css/sharing-modern.css',
    ];

    $max_mtime = time();
    foreach ($css_files as $css_file) {
      if (file_exists(DRUPAL_ROOT . '/' . $css_file)) {
        $mtime = filemtime(DRUPAL_ROOT . '/' . $css_file);
        $max_mtime = max($max_mtime, $mtime);
      }
    }

    // Apply timestamp-based versioning to all saho_tools libraries.
    foreach (['citation', 'sharing', 'citation_simple'] as $library_name) {
      if (isset($libraries[$library_name])) {
        // Update version with file modification time for cache busting.
        $libraries[$library_name]['version'] = '3.1.0-' . $max_mtime;
      }
    }
  }
}

/**
 * Implements hook_page_attachments_alter().
 */
function saho_tools_page_attachments_alter(array &$attachments) {
  // Check if we're on an admin route.
  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();

  // Only attach the citation and sharing libraries on non-admin routes.
  if (!$is_admin) {
    // Attach modal libraries - these depend on Bootstrap which loads via saho/style.
    $attachments['#attached']['library'][] = 'saho_tools/citation';
    $attachments['#attached']['library'][] = 'saho_tools/sharing';

    // Attach mobile enhancements for dropdown/offcanvas support.
    $attachments['#attached']['library'][] = 'saho/mobile.enhancements';

    // Add debugging information to check if the library is loaded.
    $attachments['#attached']['drupalSettings']['sahoTools']['debug'] = [
      'libraryLoaded' => TRUE,
      'timestamp' => time(),
      'bootstrapRequired' => TRUE,
    ];

    // If we're on a node page, add node data.
    $node = \Drupal::routeMatch()->getParameter('node');
    if ($node instanceof NodeInterface) {
      // Add node data as drupalSettings for JavaScript.
      $node_data = [
        'nid' => $node->id(),
        'title' => $node->getTitle(),
        'type' => $node->getType(),
        'created' => $node->getCreatedTime(),
        'changed' => $node->getChangedTime(),
        'url' => $node->toUrl()->setAbsolute()->toString(),
      ];

      // Add author information if available.
      if ($node->hasField('field_article_author') && !$node->get('field_article_author')->isEmpty()) {
        $node_data['author'] = $node->get('field_article_author')->value;
      }
      elseif ($node->getOwner()) {
        $node_data['author'] = $node->getOwner()->getDisplayName();
      }

      $attachments['#attached']['drupalSettings']['sahoTools']['nodeData'] = $node_data;
    }
    else {
      // For non-node pages, add basic page data.
      $current_url = \Drupal::request()->getUri();
      $site_name = \Drupal::config('system.site')->get('name');
      $page_title = \Drupal::service('title_resolver')->getTitle(
        \Drupal::request(),
        \Drupal::routeMatch()->getRouteObject()
      );

      $page_data = [
        'title' => $page_title ?: 'Page',
        'url' => $current_url,
        'site_name' => $site_name,
      ];

      $attachments['#attached']['drupalSettings']['sahoTools']['pageData'] = $page_data;
    }
  }
}

/**
 * Implements hook_preprocess_html().
 */
function saho_tools_preprocess_html(&$variables) {
  // Check if we're on an admin route.
  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();

  // Only add the citation modal container on non-admin routes.
  if (!$is_admin) {

    // Schema.org JSON-LD injection.
    $schema_service = \Drupal::service('saho_tools.schema_org_service');

    // 1. Organization schema (site-wide).
    $org_schema = $schema_service->generateOrganizationSchema();
    if (!empty($org_schema)) {
      $variables['#attached']['html_head'][] = [
        [
          '#type' => 'html_tag',
          '#tag' => 'script',
          '#attributes' => ['type' => 'application/ld+json'],
          '#value' => json_encode($org_schema, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT),
        ],
        'schema_org_organization',
      ];
    }

    // For nodes, use the canonical URL.
    $node = \Drupal::routeMatch()->getParameter('node');
    if ($node instanceof NodeInterface) {
      $canonical_url = $node->toUrl('canonical')->setAbsolute()->toString();

      // Add canonical link to head.
      $variables['#attached']['html_head'][] = [
        [
          '#type' => 'html_tag',
          '#tag' => 'link',
          '#attributes' => [
            'rel' => 'canonical',
            'href' => $canonical_url,
          ],
        ],
        'canonical_url',
      ];

      // 2. Node-specific schema.
      $node_schema = $schema_service->generateSchemaForNode($node);
      if (!empty($node_schema)) {
        $variables['#attached']['html_head'][] = [
          [
            '#type' => 'html_tag',
            '#tag' => 'script',
            '#attributes' => ['type' => 'application/ld+json'],
            '#value' => json_encode($node_schema, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT),
          ],
          'schema_org_node_' . $node->id(),
        ];
      }
    }

    // 3. Breadcrumb schema.
    $breadcrumb_schema = $schema_service->generateBreadcrumbSchema();
    if (!empty($breadcrumb_schema)) {
      $variables['#attached']['html_head'][] = [
        [
          '#type' => 'html_tag',
          '#tag' => 'script',
          '#attributes' => ['type' => 'application/ld+json'],
          '#value' => json_encode($breadcrumb_schema, JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT),
        ],
        'schema_org_breadcrumb',
      ];
    }

    // Add streamlined citation modal - minimal structure, content loaded via template/JS.
    $variables['page_bottom']['citation_modal'] = [
      '#type' => 'html_tag',
      '#tag' => 'div',
      '#attributes' => [
        'id' => 'citation-modal',
        'class' => ['modal', 'fade'],
        'tabindex' => '-1',
        'aria-labelledby' => 'citation-modal-label',
        'aria-hidden' => 'true',
      ],
      '#value' => '<div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="citation-modal-label">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M12 12a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1h-1.388c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 9 7.558V11a1 1 0 0 0 1 1h2Zm-6 0a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1H4.612c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 3 7.558V11a1 1 0 0 0 1 1h2Z"/>
              </svg>
              Cite This Page
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="citation-content">
              <!-- Citation content will be loaded here by JavaScript -->
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading citations...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>',
    ];

    // Add sharing modal
    // Get the current node for description if available.
    $node = \Drupal::routeMatch()->getParameter('node');
    $description = '';
    if ($node instanceof NodeInterface && $node->hasField('body') && !$node->get('body')->isEmpty()) {
      // Get a short excerpt from the body for the description.
      $body_value = $node->get('body')->value;
      $description = strip_tags($body_value);
      // Limit to 150 characters.
      if (strlen($description) > 150) {
        $description = substr($description, 0, 150) . '...';
      }
    }

    // Create a modern sharing modal.
    $current_url = \Drupal::request()->getUri();

    // Ensure current URL is a string.
    if (!is_string($current_url) || empty($current_url)) {
      $current_url = \Drupal::request()->getSchemeAndHttpHost();
    }
    $page_title = \Drupal::service('title_resolver')->getTitle(\Drupal::request(), \Drupal::routeMatch()->getRouteObject());

    // Ensure page title is a string.
    if (is_array($page_title)) {
      // Handle nested arrays or render arrays.
      if (isset($page_title['#markup'])) {
        $page_title = $page_title['#markup'];
      }
      elseif (isset($page_title['#plain_text'])) {
        $page_title = $page_title['#plain_text'];
      }
      else {
        // Flatten array, filtering out non-scalar values.
        $flat_title = [];
        array_walk_recursive($page_title, function ($value) use (&$flat_title) {
          if (is_scalar($value)) {
            $flat_title[] = $value;
          }
        });
        $page_title = implode(' ', $flat_title);
      }
    }
    if (is_object($page_title) && method_exists($page_title, '__toString')) {
      $page_title = (string) $page_title;
    }
    if (empty($page_title) || !is_string($page_title)) {
      $page_title = \Drupal::config('system.site')->get('name') ?: 'South African History Online';
    }

    // Additional safety - ensure both are strings before using in URLs.
    $current_url = (string) $current_url;
    $page_title = (string) $page_title;

    // Add streamlined sharing modal - minimal structure, content populated by JavaScript.
    $variables['page_bottom']['sharing_modal'] = [
      '#type' => 'html_tag',
      '#tag' => 'div',
      '#attributes' => [
        'id' => 'sharing-modal',
        'class' => ['modal', 'fade'],
        'tabindex' => '-1',
        'aria-labelledby' => 'sharing-modal-label',
        'aria-hidden' => 'true',
      ],
      '#value' => '<div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sharing-modal-label">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>
              </svg>
              Share This Page
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="sharing-content">
              <!-- Sharing content will be populated by JavaScript -->
              <div class="sharing-options">
                <a href="https://www.facebook.com/sharer/sharer.php?u=' . urlencode($current_url) . '" 
                   target="_blank" rel="noopener noreferrer" class="share-option">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/>
                  </svg>
                  Facebook
                </a>
                <a href="https://twitter.com/intent/tweet?url=' . urlencode($current_url) . '&text=' . urlencode($page_title) . '" 
                   target="_blank" rel="noopener noreferrer" class="share-option">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
                  </svg>
                  Twitter
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=' . urlencode($current_url) . '" 
                   target="_blank" rel="noopener noreferrer" class="share-option">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/>
                  </svg>
                  LinkedIn
                </a>
                <a href="mailto:?subject=' . urlencode($page_title) . '&body=' . urlencode('Check out this page: ' . $current_url) . '" 
                   class="share-option">
                  <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                  </svg>
                  Email
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>',
      '#attached' => [
        'library' => [
          'saho_tools/sharing',
        ],
      ],
    ];
  }
}

/**
 * Implements hook_page_attachments().
 */
function saho_tools_page_attachments(array &$attachments) {
  // Check if we're on an admin route.
  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();

  // Only add the script to modify the Cite This Page link on non-admin routes.
  if (!$is_admin) {
    // Add inline script to modify the Cite This Page link to use data attribute only.
    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#value' => "
          document.addEventListener('DOMContentLoaded', function() {
            var citeLinks = document.querySelectorAll('a[href=\"#cite\"]');
            citeLinks.forEach(function(link) {
              link.setAttribute('data-citation-trigger', 'true');
              // Keep original href for SEO crawlability - don't override with javascript:void(0)
            });
          });
        ",
      ],
      'saho_tools_cite_link_modifier',
    ];
  }
}

/**
 * Implements hook_preprocess_node().
 */
function saho_tools_preprocess_node(&$variables) {
  // Add citation data to the node template.
  $node = $variables['node'];

  // Only proceed if we're viewing a full node.
  if ($variables['view_mode'] == 'full') {
    // Add citation data as attributes for potential use in templates.
    $variables['attributes']['data-citation-title'] = $node->getTitle();
    $variables['attributes']['data-citation-url'] = $node->toUrl()->setAbsolute()->toString();
    $variables['attributes']['data-citation-date'] = date('Y-m-d', $node->getChangedTime());

    // Add author information if available.
    if ($node->hasField('field_article_author') && !$node->get('field_article_author')->isEmpty()) {
      $variables['attributes']['data-citation-author'] = $node->get('field_article_author')->value;
    }
    elseif ($node->getOwner()) {
      $variables['attributes']['data-citation-author'] = $node->getOwner()->getDisplayName();
    }
    else {
      $variables['attributes']['data-citation-author'] = 'South African History Online';
    }

    // Add the citation button to the node template.
    $variables['citation_button'] = [
      '#theme' => 'citation_button',
      '#attributes' => [
        'class' => ['citation-button', 'btn', 'btn-sm', 'btn-outline-primary'],
        'data-citation-trigger' => 'true',
      ],
      '#title' => t('Cite This Page'),
      '#attached' => [
        'library' => ['saho_tools/citation'],
      ],
    ];

    // Add the sharing button to the node template.
    $variables['sharing_button'] = [
      '#theme' => 'sharing_button',
      '#attributes' => [
        'class' => ['sharing-button', 'btn', 'btn-sm', 'btn-success'],
        'data-sharing-trigger' => 'true',
      ],
      '#title' => t('Share'),
      '#attached' => [
        'library' => ['saho_tools/sharing'],
      ],
    ];
  }
}

/**
 * Implements hook_theme_suggestions_HOOK_alter() for node templates.
 */
function saho_tools_theme_suggestions_node_alter(array &$suggestions, array $variables) {
  // Add a theme suggestion for each content type.
  $node = $variables['elements']['#node'];
  $sanitized_view_mode = strtr($variables['elements']['#view_mode'], '.', '_');

  // Add a suggestion for the view mode and content type.
  $suggestions[] = 'node__' . $sanitized_view_mode . '__' . $node->bundle();
}

/**
 * Implements hook_metatag_tags_alter().
 */
function saho_tools_metatag_tags_alter(array &$metatags, $context) {
  // Check if context is an array and contains an entity.
  if (!is_array($context) || empty($context['entity'])) {
    return;
  }

  // Only proceed if we have a node entity.
  if ($context['entity'] instanceof NodeInterface) {
    $node = $context['entity'];
    $node_type = $node->getType();
    $image_url = '';

    // Define a mapping of content types to their image fields in priority order.
    $type_field_map = [
      'article' => ['field_main_image', 'field_article_image', 'field_image'],
      'biography' => ['field_bio_pic'],
      'place' => ['field_place_image'],
      'archive' => ['field_archive_image', 'field_image'],
      'event' => ['field_event_image', 'field_tdih_image'],
      'image' => ['field_image'],
      'gallery_image' => ['field_gallery_image'],
      'button' => ['field_button_image'],
      'product' => ['field_product_image'],
      'upcomingevent' => ['field_upcomingevent_image'],
      'page' => ['field_image'],
    ];

    // Get the appropriate image field based on content type.
    if (isset($type_field_map[$node_type])) {
      // Try each field in priority order.
      foreach ($type_field_map[$node_type] as $field_name) {
        if ($node->hasField($field_name) && !$node->get($field_name)->isEmpty()) {
          $image_url = _saho_tools_get_image_url($node, $field_name);
          if (!empty($image_url)) {
            // Stop once we find a valid image.
            break;
          }
        }
      }
    }

    // If we found an image URL, set it for all Open Graph image tags.
    if (!empty($image_url)) {
      // Set the main og:image tag.
      $metatags['og_image'] = $image_url;

      // Also set the alternative og:image:url tag.
      $metatags['og_image_url'] = $image_url;

      // If the URL is https, also set the secure URL tag.
      if (strpos($image_url, 'https://') === 0) {
        $metatags['og_image_secure_url'] = $image_url;
      }
    }
  }
}

/**
 * Helper function to get the absolute URL of an image from a node field.
 *
 * @param \Drupal\node\NodeInterface $node
 *   The node entity.
 * @param string $field_name
 *   The name of the image field.
 *
 * @return string
 *   The absolute URL of the image, or an empty string if not found.
 */
function _saho_tools_get_image_url(NodeInterface $node, string $field_name) {
  $image_url = '';

  // Get the file entity from the field.
  $file_entity = NULL;

  // Cache the field value to avoid repeated method calls.
  $field_value = $node->get($field_name);

  // Handle both entity reference fields and file fields.
  if ($field_value->entity instanceof File) {
    $file_entity = $field_value->entity;
  }
  elseif ($field_value->entity instanceof FieldableEntityInterface && $field_value->entity->hasField('field_media_image')) {
    // For media entity reference fields, get the file from the media entity.
    $media_entity = $field_value->entity;
    if (!$media_entity->get('field_media_image')->isEmpty()) {
      $file_entity = $media_entity->get('field_media_image')->entity;
    }
  }

  // Generate the absolute URL if we have a file entity.
  if ($file_entity instanceof File) {
    $image_url = \Drupal::service('file_url_generator')->generateAbsoluteString($file_entity->getFileUri());
  }

  return $image_url;
}

/**
 * Implements hook_theme().
 */
function saho_tools_theme() {
  return [
    'citation_button' => [
      'variables' => [
        'attributes' => [],
        'title' => 'Cite This Page',
      ],
      'template' => 'citation-button',
    ],
    'sharing_button' => [
      'variables' => [
        'attributes' => [],
        'title' => 'Share',
      ],
      'template' => 'sharing-button',
    ],
    'citation_formatter_all' => [
      'variables' => [
        'citations' => NULL,
      ],
      'template' => 'citation-formatter-all',
    ],
    'citation_formatter_single' => [
      'variables' => [
        'citation' => NULL,
        'format' => NULL,
      ],
      'template' => 'citation-formatter-single',
    ],
    'node__citation' => [
      'variables' => [
        'citation_button' => NULL,
      ],
      'template' => 'node--citation',
    ],
  ];
}
