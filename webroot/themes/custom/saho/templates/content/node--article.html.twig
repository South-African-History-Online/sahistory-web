{#
/**
 * @file
 * Custom SAHO node template.
 *
 * Title is handled globally and not rendered here.
 * Layout Builder is disabled â€” fields are output directly via Twig.
 */
#}

{# Variable to track if sidebar has content #}
{% set sidebar_has_content = false %}

<article{{ attributes.addClass('saho-article-wrapper') }}>

  <div class="saho-article-grid">

    {# LEFT: Main content column #}
    <div class="saho-main-content">

      {% if hero_banner_image %}
        {# Feature banner image (eager loading for LCP) #}
        <div class="saho-feature-banner">
          {{ hero_banner_image }}
        </div>
      {% elseif article_image and not hero_banner_image %}
        {# Display article image in main content if no feature banner #}
        <div class="saho-feature-banner">
          {{ article_image }}
          {% if node.field_node_image_caption.value %}
            <div class="caption">
              {{ node.field_node_image_caption.value|raw }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      <div class="saho-article-meta">
        {% if node.getCreatedTime() %}
          <span>Published {{ node.getCreatedTime()|date("j F Y") }}</span>
        {% endif %}
        {% if node.getChangedTime() != node.getCreatedTime() %}
          <span>Updated {{ node.getChangedTime()|date("j F Y") }}</span>
        {% endif %}
        <div class="saho-tools-wrapper">
          {% if citation_button %}
            <div class="saho-citation-wrapper">
              {{ citation_button }}
            </div>
          {% endif %}
          {% if sharing_button %}
            <div class="saho-sharing-wrapper">
              {{ sharing_button }}
            </div>
          {% endif %}
        </div>
      </div>

      {% if content.body %}
        <div class="saho-article-body">
          {# Article contents page field integrated within body text like biography metadata #}
          {% if content.field_article_contents_page is defined and content.field_article_contents_page|render|trim %}
            <div class="saho-article-index">
              <h4>Contents</h4>
              <div class="saho-index-content">
                {{ content.field_article_contents_page }}
              </div>
            </div>
          {% endif %}

          {# Main body content #}
          {{ content.body.0 }}
        </div>
      {% endif %}

      {% if content.field_tags is defined and content.field_tags|render|trim %}
        <div class="saho-tags">
          <h4>Tags</h4>
          <ul class="saho-tags-list">
            {% for item in node.field_tags %}
              <li>
                <a href="{{ path('entity.taxonomy_term.canonical', {'taxonomy_term': item.target_id}) }}">
                  {{ item.entity.label }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if content.field_highlight %}
        <div class="saho-highlight">
          {{ content.field_highlight }}
        </div>
      {% endif %}


      {# Render remaining fields not already shown manually #}
      {{ content|without(
        'body',
        'field_highlight',
        'field_further_reading',
        'field_article_image',
        'field_node_image_caption',
        'field_ref_str',
        'field_african_country',
        'field_article_type',
        'field_tags',
        'field_topics_related_tab',
        'field_people_related_tab',
        'field_archive_page_feature',
        'field_feature_parent',
        'field_parent',
        'field_feature_tag',
        'field_politics_society_categorie',
        'field_timeline_categories_type',
        'field_feature_banner',
        'field_africa_category',
        'field_image',
        'field_featured',
        'field_gallery_tag',
        'field_timelines_related_tab',
        'field_article_contents_page',
        'sharing_buttons'
      ) }}

    </div>


    {# RIGHT: Simplified Sidebar #}
    {% if node.field_article_image.entity and node.field_feature_banner.entity %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if accordion_views is not empty %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if content.field_archive_page_feature is defined and content.field_archive_page_feature|render|trim %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if content.field_africa_category is defined and content.field_africa_category|render|trim %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if content.field_topics_related_tab is defined and content.field_topics_related_tab|render|trim %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if content.field_people_related_tab is defined and content.field_people_related_tab|render|trim %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if content.field_feature_parent is defined and content.field_feature_parent|render|trim %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if content.field_timeline_categories_type is defined and content.field_timeline_categories_type|render|trim %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if content.field_further_reading is defined and content.field_further_reading|render|trim %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if node.field_ref_str.value %}
      {% set sidebar_has_content = true %}
    {% endif %}
    
    {% if sidebar_has_content %}
    <aside class="saho-article-sidebar">

      {# Article Image Block - Only show in sidebar if there's a hero banner #}
      {% if article_image and hero_banner_image %}
        <div class="saho-image-block mb-4">
          {{ article_image }}
          {% if node.field_node_image_caption.value %}
            <div class="caption">
              {{ node.field_node_image_caption.value|raw }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# Custom Accordion for feature_children views #}
      {% if accordion_views is not empty %}
        <div class="saho-accordion mb-5" id="sahoFeatureAccordion">
          {% for item in accordion_views %}
            <div class="saho-accordion-item">
              <h4 class="saho-accordion-header">
                <button class="saho-accordion-button {% if not loop.first %}collapsed{% endif %}" 
                        type="button" 
                        aria-expanded="{{ loop.first ? 'true' : 'false' }}" 
                        aria-controls="collapse-{{ item.id }}"
                        data-target="#collapse-{{ item.id }}">
                  {{ item.title }}
                </button>
              </h4>
              <div id="collapse-{{ item.id }}" 
                   class="saho-accordion-collapse {% if loop.first %}show{% endif %}" 
                   aria-hidden="{{ loop.first ? 'false' : 'true' }}">
                <div class="saho-accordion-body">
                  {{ drupal_view(item.view, item.block, node.id()) }}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {# Simple sections for entity reference fields #}
      {% if content.field_archive_page_feature is defined and content.field_archive_page_feature|render|trim %}
        <div class="saho-taxonomy-group">
          <h4>Organisations</h4>
          {{ content.field_archive_page_feature }}
        </div>
      {% endif %}


      {% if content.field_africa_category is defined and content.field_africa_category|render|trim %}
        <div class="saho-taxonomy-group">
          <h4>Archive</h4>
          {{ content.field_africa_category }}
        </div>
      {% endif %}

      {% if content.field_topics_related_tab is defined and content.field_topics_related_tab|render|trim %}
        <div class="saho-taxonomy-group">
          <h4>Related Topics</h4>
          {{ content.field_topics_related_tab }}
        </div>
      {% endif %}

      {% if content.field_people_related_tab is defined and content.field_people_related_tab|render|trim %}
        <div class="saho-taxonomy-group">
          <h4>Related People</h4>
          {{ content.field_people_related_tab }}
        </div>
      {% endif %}

      {% if content.field_feature_parent is defined and content.field_feature_parent|render|trim %}
        <div class="saho-taxonomy-group">
          <h4>Related Content</h4>
          {{ content.field_feature_parent }}
        </div>
      {% endif %}

      {% if content.field_timeline_categories_type is defined and content.field_timeline_categories_type|render|trim %}
        <div class="saho-taxonomy-group">
          <h4>Timelines</h4>
          {{ content.field_timeline_categories_type }}
        </div>
      {% endif %}

      {% if content.field_further_reading is defined and content.field_further_reading|render|trim %}
        <div class="saho-further-reading">
          <h4>Further Reading</h4>
          {{ content.field_further_reading }}
        </div>
      {% endif %}

      {# References section #}
      {% if node.field_ref_str.value %}
        {% set refs = node.field_ref_str.value|split('|') %}
        <div class="saho-references">
          <h4>References</h4>
          <ul class="saho-reference-list">
            {% for ref in refs %}
              {% if ref|trim %}
                <li>{{ ref|trim|raw }}</li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

    </aside>
    {% endif %}

  </div>

</article>

{# Enhanced Related Content & Topics section with dynamic content #}
{% set has_context = content.field_topics_related_tab|render|trim or content.field_people_related_tab|render|trim or content.field_feature_parent|render|trim or content.field_archive_page_feature|render|trim or content.field_africa_category|render|trim or content.field_timeline_categories_type|render|trim or content.field_further_reading|render|trim %}

{# Use enhanced suggested reading if available, fallback to existing logic #}
{% if suggested_reading is defined and suggested_reading is not empty %}
  <div class="saho-context-sections saho-context-bottom saho-suggested-reading-enhanced">
    <h3>Related Content & Topics</h3>

    {% for section_title, items in suggested_reading %}
      <div class="saho-related-content-section">
        <h4>{{ section_title }}</h4>
        <div class="saho-cards-grid">
          {% for item in items %}
            {% set entity = item.entity %}
            {% set image_url = null %}

{# Get image URL based on content type and available fields #}
            {% set bundle = entity.bundle %}

            {# Content-type specific image field priority #}
            {% if bundle == 'biography' %}
              {% if entity.field_bio_pic.entity %}
                {% set image_url = file_url(entity.field_bio_pic.entity.uri.value) %}
                {% set image_alt = entity.field_bio_pic.alt %}
              {% elseif entity.field_feature_banner.entity %}
                {% set image_url = file_url(entity.field_feature_banner.entity.uri.value) %}
                {% set image_alt = entity.field_feature_banner.alt %}
              {% endif %}

            {% elseif bundle == 'article' %}
              {% if entity.field_article_image.entity %}
                {% set image_url = file_url(entity.field_article_image.entity.uri.value) %}
                {% set image_alt = entity.field_article_image.alt %}
              {% elseif entity.field_feature_banner.entity %}
                {% set image_url = file_url(entity.field_feature_banner.entity.uri.value) %}
                {% set image_alt = entity.field_feature_banner.alt %}
              {% endif %}

            {% elseif bundle == 'archive' %}
              {% if entity.field_archive_image.entity %}
                {% set image_url = file_url(entity.field_archive_image.entity.uri.value) %}
                {% set image_alt = entity.field_archive_image.alt %}
              {% elseif entity.field_image.entity %}
                {% set image_url = file_url(entity.field_image.entity.uri.value) %}
                {% set image_alt = entity.field_image.alt %}
              {% endif %}

            {% elseif bundle == 'place' %}
              {% if entity.field_place_image.entity %}
                {% set image_url = file_url(entity.field_place_image.entity.uri.value) %}
                {% set image_alt = entity.field_place_image.alt %}
              {% elseif entity.field_feature_banner.entity %}
                {% set image_url = file_url(entity.field_feature_banner.entity.uri.value) %}
                {% set image_alt = entity.field_feature_banner.alt %}
              {% endif %}

            {% elseif bundle == 'event' %}
              {% if entity.field_event_image.entity %}
                {% set image_url = file_url(entity.field_event_image.entity.uri.value) %}
                {% set image_alt = entity.field_event_image.alt %}
              {% elseif entity.field_tdih_image.entity %}
                {% set image_url = file_url(entity.field_tdih_image.entity.uri.value) %}
                {% set image_alt = entity.field_tdih_image.alt %}
              {% endif %}

            {% else %}
              {# Fallback for other content types #}
              {% if entity.field_image.entity %}
                {% set image_url = file_url(entity.field_image.entity.uri.value) %}
                {% set image_alt = entity.field_image.alt %}
              {% elseif entity.field_article_image.entity %}
                {% set image_url = file_url(entity.field_article_image.entity.uri.value) %}
                {% set image_alt = entity.field_article_image.alt %}
              {% elseif entity.field_feature_banner.entity %}
                {% set image_url = file_url(entity.field_feature_banner.entity.uri.value) %}
                {% set image_alt = entity.field_feature_banner.alt %}
              {% endif %}
            {% endif %}

            <div class="saho-card">
              <a href="{{ path('entity.node.canonical', {'node': entity.id()}) }}" class="saho-card-link">
                {% if image_url %}
                <div class="saho-card-image">
                  <img src="{{ image_url }}" alt="{{ image_alt }}" loading="lazy" decoding="async">
                </div>
                {% endif %}
                <div class="saho-card-content">
                  <h5 class="saho-card-title">{{ entity.label }}</h5>
                  {% if entity.field_synopsis.value %}
                    <p class="saho-card-description">{{ entity.field_synopsis.value|striptags|truncate(120) }}</p>
                  {% elseif entity.body.value %}
                    <p class="saho-card-description">{{ entity.body.value|striptags|truncate(120) }}</p>
                  {% endif %}
                  <div class="saho-card-footer">
                    <span class="saho-card-button">
                      Read More
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                      </svg>
                    </span>
                  </div>
                </div>
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
{% elseif has_context %}
  <div class="saho-context-sections saho-context-bottom">
    <h3>Related Content & Topics</h3>
    
    {% if content.field_people_related_tab is defined and content.field_people_related_tab|render|trim %}
      <div class="saho-related-content-section">
        <h4>Related People</h4>
        <div class="saho-cards-grid">
          {% if node.field_people_related_tab %}
            {% for item in content.field_people_related_tab['#items'] %}
              {% if item.entity %}
                <div class="saho-card">
                  <a href="{{ path('entity.node.canonical', {'node': item.target_id}) }}" class="saho-card-link">
                    {% if item.entity.field_bio_pic.entity or item.entity.field_article_image.entity or item.entity.field_image.entity or item.entity.field_event_image.entity or item.entity.field_tdih_image.entity %}
                      <div class="saho-card-image">
                        {% set image = item.entity.field_bio_pic.entity ?: (item.entity.field_article_image.entity ?: (item.entity.field_image.entity ?: (item.entity.field_event_image.entity ?: item.entity.field_tdih_image.entity))) %}
                        <img src="{{ file_url(image.uri.value) }}" alt="{{ image.alt }}" loading="lazy">
                      </div>
                    {% endif %}
                    <div class="saho-card-content">
                      <h5 class="saho-card-title">{{ item.entity.label }}</h5>
                      {% if item.entity.field_synopsis.value %}
                        <p class="saho-card-description">{{ item.entity.field_synopsis.value|striptags|truncate(120) }}</p>
                      {% endif %}
                      <div class="saho-card-footer">
                        <span class="saho-card-button">
                          Read More
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                          </svg>
                        </span>
                      </div>
                    </div>
                  </a>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {{ content.field_people_related_tab }}
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if content.field_archive_page_feature is defined and content.field_archive_page_feature|render|trim %}
      <div class="saho-related-content-section">
        <h4>Organisations</h4>
        <div class="saho-cards-grid">
          {% if node.field_archive_page_feature %}
            {% for item in content.field_archive_page_feature['#items'] %}
              {% if item.entity %}
                <div class="saho-card">
                  <a href="{{ path('entity.node.canonical', {'node': item.target_id}) }}" class="saho-card-link">
                    {% if item.entity.field_article_image.entity or item.entity.field_image.entity or item.entity.field_bio_pic.entity or item.entity.field_event_image.entity or item.entity.field_tdih_image.entity %}
                      <div class="saho-card-image">
                        {% set image = item.entity.field_article_image.entity ?: (item.entity.field_image.entity ?: (item.entity.field_bio_pic.entity ?: (item.entity.field_event_image.entity ?: item.entity.field_tdih_image.entity))) %}
                        <img src="{{ file_url(image.uri.value) }}" alt="{{ image.alt }}" loading="lazy">
                      </div>
                    {% endif %}
                    <div class="saho-card-content">
                      <h5 class="saho-card-title">{{ item.entity.label }}</h5>
                      {% if item.entity.field_synopsis.value %}
                        <p class="saho-card-description">{{ item.entity.field_synopsis.value|striptags|truncate(120) }}</p>
                      {% endif %}
                      <div class="saho-card-footer">
                        <span class="saho-card-button">
                          Read More
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                          </svg>
                        </span>
                      </div>
                    </div>
                  </a>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {{ content.field_archive_page_feature }}
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if content.field_timeline_categories_type is defined and content.field_timeline_categories_type|render|trim %}
      <div class="saho-related-content-section">
        <h4>Timelines</h4>
        <div class="saho-cards-grid">
          {% if node.field_timeline_categories_type %}
            {% for item in content.field_timeline_categories_type['#items'] %}
              {% if item.entity %}
                <div class="saho-card">
                  <a href="{{ path('entity.node.canonical', {'node': item.target_id}) }}" class="saho-card-link">
                    {% if item.entity.field_article_image.entity or item.entity.field_image.entity or item.entity.field_event_image.entity %}
                      <div class="saho-card-image">
                        {% set image = item.entity.field_article_image.entity ?: (item.entity.field_image.entity ?: item.entity.field_event_image.entity) %}
                        <img src="{{ file_url(image.uri.value) }}" alt="{{ image.alt }}" loading="lazy">
                      </div>
                    {% endif %}
                    <div class="saho-card-content">
                      <h5 class="saho-card-title">{{ item.entity.label }}</h5>
                      {% if item.entity.field_synopsis.value %}
                        <p class="saho-card-description">{{ item.entity.field_synopsis.value|striptags|truncate(120) }}</p>
                      {% endif %}
                      <div class="saho-card-footer">
                        <span class="saho-card-button">
                          Read More
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                          </svg>
                        </span>
                      </div>
                    </div>
                  </a>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {{ content.field_timeline_categories_type }}
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if content.field_africa_category is defined and content.field_africa_category|render|trim %}
      <div class="saho-related-content-section">
        <h4>Archive</h4>
        <div class="saho-cards-grid">
          {% if node.field_africa_category %}
            {% for item in content.field_africa_category['#items'] %}
              {% if item.entity %}
                <div class="saho-card">
                  <a href="{{ path('entity.node.canonical', {'node': item.target_id}) }}" class="saho-card-link">
                    {% if item.entity.field_article_image.entity or item.entity.field_image.entity or item.entity.field_archive_image.entity or item.entity.field_event_image.entity or item.entity.field_tdih_image.entity %}
                      <div class="saho-card-image">
                        {% set image = item.entity.field_article_image.entity ?: (item.entity.field_image.entity ?: (item.entity.field_archive_image.entity ?: (item.entity.field_event_image.entity ?: item.entity.field_tdih_image.entity))) %}
                        <img src="{{ file_url(image.uri.value) }}" alt="{{ image.alt }}" loading="lazy">
                      </div>
                    {% endif %}
                    <div class="saho-card-content">
                      <h5 class="saho-card-title">{{ item.entity.label }}</h5>
                      {% if item.entity.field_synopsis.value %}
                        <p class="saho-card-description">{{ item.entity.field_synopsis.value|striptags|truncate(120) }}</p>
                      {% endif %}
                      <div class="saho-card-footer">
                        <span class="saho-card-button">
                          Read More
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                          </svg>
                        </span>
                      </div>
                    </div>
                  </a>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {{ content.field_africa_category }}
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if content.field_topics_related_tab is defined and content.field_topics_related_tab|render|trim %}
      <div class="saho-related-content-section">
        <h4>Related Topics</h4>
        <div class="saho-cards-grid">
          {% if node.field_topics_related_tab %}
            {% for item in content.field_topics_related_tab['#items'] %}
              {% if item.entity %}
                <div class="saho-card">
                  <a href="{{ path('entity.node.canonical', {'node': item.target_id}) }}" class="saho-card-link">
                    {% if item.entity.field_article_image.entity or item.entity.field_image.entity or item.entity.field_archive_image.entity or item.entity.field_bio_pic.entity or item.entity.field_event_image.entity or item.entity.field_tdih_image.entity %}
                      <div class="saho-card-image">
                        {% set image = item.entity.field_article_image.entity ?: (item.entity.field_image.entity ?: (item.entity.field_archive_image.entity ?: (item.entity.field_bio_pic.entity ?: (item.entity.field_event_image.entity ?: item.entity.field_tdih_image.entity)))) %}
                        <img src="{{ file_url(image.uri.value) }}" alt="{{ image.alt }}" loading="lazy">
                      </div>
                    {% endif %}
                    <div class="saho-card-content">
                      <h5 class="saho-card-title">{{ item.entity.label }}</h5>
                      {% if item.entity.field_synopsis.value %}
                        <p class="saho-card-description">{{ item.entity.field_synopsis.value|striptags|truncate(120) }}</p>
                      {% endif %}
                      <div class="saho-card-footer">
                        <span class="saho-card-button">
                          Read More
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                          </svg>
                        </span>
                      </div>
                    </div>
                  </a>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {{ content.field_topics_related_tab }}
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if content.field_feature_parent is defined and content.field_feature_parent|render|trim %}
      <div class="saho-related-content-section">
        <h4>Related Content</h4>
        <div class="saho-cards-grid">
          {% for item in content.field_feature_parent['#items'] %}
            {% if item.entity %}
              <div class="saho-card">
                <a href="{{ path('entity.node.canonical', {'node': item.target_id}) }}" class="saho-card-link">
                  {% if item.entity.field_article_image.entity or item.entity.field_image.entity or item.entity.field_bio_pic.entity or item.entity.field_event_image.entity or item.entity.field_tdih_image.entity %}
                    <div class="saho-card-image">
                      {% set image = item.entity.field_article_image.entity ?: (item.entity.field_image.entity ?: (item.entity.field_bio_pic.entity ?: (item.entity.field_event_image.entity ?: item.entity.field_tdih_image.entity))) %}
                      <img src="{{ file_url(image.uri.value) }}" alt="{{ image.alt }}" loading="lazy">
                    </div>
                  {% endif %}
                  <div class="saho-card-content">
                    <h5 class="saho-card-title">{{ item.entity.label }}</h5>
                    {% if item.entity.field_synopsis.value %}
                      <p class="saho-card-description">{{ item.entity.field_synopsis.value|striptags|truncate(120) }}</p>
                    {% endif %}
                    <div class="saho-card-footer">
                      <span class="saho-card-button">
                        Read More
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                        </svg>
                      </span>
                    </div>
                  </div>
                </a>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if content.field_further_reading is defined and content.field_further_reading|render|trim %}
      <div class="saho-related-content-section">
        <h4>Further Reading</h4>
        <div class="saho-cards-grid">
          {% if node.field_further_reading.value %}
            {% set reading_items = node.field_further_reading.value|split('\n') %}
            {% for item in reading_items %}
              {% if item|trim %}
                {% set processed_item = item|trim %}
                
                {# Check if it's an HTML anchor tag #}
                {% if '<a href=' in processed_item %}
                  {% set href_match = processed_item|split('href="')[1]|split('"')[0] %}
                  {% set title_match = processed_item|striptags|trim %}
                  {% if href_match and href_match starts with 'http' %}
                    {% set url = href_match %}
                    {% set title = title_match ?: url %}
                  {% endif %}
                {# Check if it's a pipe-delimited format #}
                {% elseif '|' in processed_item %}
                  {% set link_parts = processed_item|split('|') %}
                  {% set url = link_parts[0]|trim %}
                  {% set title = link_parts[1] is defined ? link_parts[1]|trim : url %}
                  {% set description = link_parts[2] is defined ? link_parts[2]|trim : '' %}
                {# Check if it's just a plain URL #}
                {% elseif processed_item starts with 'http' %}
                  {% set url = processed_item %}
                  {% set title = url %}
                {% else %}
                  {% set url = null %}
                {% endif %}
                
                {# Only display if we have a valid URL #}
                {% if url is defined and url starts with 'http' %}
                  <div class="saho-card">
                    <a href="{{ url }}" class="saho-card-link" target="_blank" rel="noopener">
                      <div class="saho-card-content">
                        <h5 class="saho-card-title">{{ title|length > 80 ? title|slice(0, 77) ~ '...' : title }}</h5>
                        {% if description is defined and description %}
                          <p class="saho-card-description">{{ description|length > 120 ? description|slice(0, 117) ~ '...' : description }}</p>
                        {% endif %}
                        <div class="saho-card-footer">
                          <span class="saho-card-button">
                            Read More
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                              <path d="M8.22 2.97a.75.75 0 0 1 1.06 0L14 7.69a.75.75 0 0 1 0 1.06L9.28 13.47a.75.75 0 0 1-1.06-1.06L11.44 9.25H2.75a.75.75 0 0 1 0-1.5h8.69L8.22 4.53a.75.75 0 0 1 0-1.06z"/>
                            </svg>
                          </span>
                        </div>
                      </div>
                    </a>
                  </div>
                {% endif %}
                {% set url = null %}
                {% set title = null %}
                {% set description = null %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}
