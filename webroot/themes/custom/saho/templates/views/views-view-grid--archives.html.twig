{#
/**
 * @file
 * Unified grid template for all card-based views (DRY approach).
 *
 * This template consolidates card rendering for:
 * - Landing pages (Politics & Society, Art & Culture, etc.)
 * - Archive pages
 * - Taxonomy term pages
 * - Biography browse pages
 *
 * Replaces duplicate code in:
 * - views-view-grid--landing-page.html.twig (366 lines)
 * - views-view-grid--archives.html.twig (184 lines)
 * - views-view-grid--archive-pages--page-*.html.twig
 *
 * Available variables:
 * - attributes: HTML attributes for the wrapping element.
 * - title: The title of this group of rows.
 * - view: The view object.
 * - items: The items contained in this view.
 * - options: The view plugin style options.
 *
 * @see template_preprocess_views_view_grid()
 */
#}

{# Detect view context for theming #}
{% set view_id = view.id() %}
{% set display_id = view.current_display %}
{% set is_landing_page = view_id starts with 'landing_page_' %}
{% set is_archive = view_id starts with 'archive' or 'archive' in view_id %}

{# Section-specific theming for landing pages #}
{% set section_name = view_id|replace({'landing_page_': '', '_': ' '})|title %}
{% set section_colors = {
  'Politics Society': 'deep-heritage-red',
  'Art Culture': 'muted-gold',
  'Biographies': 'slate-blue',
  'Africa': 'faded-brick-red',
  'Classroom': 'deep-heritage-red',
  'Places': 'slate-blue',
  'Timelines': 'muted-gold',
  'Archives': 'dark-charcoal'
} %}
{% set section_color = section_colors[section_name] ?? 'deep-heritage-red' %}

{# Default content type for fallback #}
{% set default_content_type = is_archive ? 'Archive' : section_name %}

{# Placeholder icon mapping #}
{% set placeholder_icons = {
  'Biography': 'fa-user',
  'Article': 'fa-newspaper',
  'Event': 'fa-calendar',
  'Place': 'fa-map-marker-alt',
  'Archive': 'fa-archive',
  'Collection': 'fa-folder',
  'default': 'fa-file-alt'
} %}

{# Use unified cards grid system #}
<div{{ attributes.addClass('saho-cards-grid') }}>
  {% for row in items %}
    {% for column in row.content %}
      {% if column.content %}
        {# Extract node entity from various possible sources #}
        {% set node = false %}
        {% if column.content['#row'] is defined and column.content['#row']._entity is defined %}
          {% set node = column.content['#row']._entity %}
        {% elseif column.content['#node'] is defined %}
          {% set node = column.content['#node'] %}
        {% endif %}

        {# Build card data from node #}
        {% set card_data = {
          title: false,
          body: false,
          url: false,
          date: false,
          image_url: false,
          content_type: default_content_type
        } %}

        {% if node %}
          {% set card_data = card_data|merge({
            title: node.label(),
            content_type: node.bundle()|capitalize,
            url: path('entity.node.canonical', {'node': node.id()}),
            date: node.getChangedTime()|date('j F Y')
          }) %}

          {# Get body/synopsis #}
          {% if node.hasField('field_synopsis') and not node.get('field_synopsis').isEmpty() %}
            {% set card_data = card_data|merge({body: node.get('field_synopsis').value}) %}
          {% elseif node.hasField('body') and not node.get('body').isEmpty() %}
            {% set card_data = card_data|merge({body: node.get('body').value}) %}
          {% endif %}

          {# Get image from various possible field names #}
          {% set image_fields = ['field_image', 'field_article_image', 'field_bio_pic', 'field_place_image', 'field_event_image', 'field_archive_image'] %}
          {% for image_field in image_fields %}
            {% if not card_data.image_url and node.hasField(image_field) and not node.get(image_field).isEmpty() %}
              {% set file_entity = node.get(image_field).entity %}
              {% if file_entity %}
                {% set card_data = card_data|merge({image_url: file_url(file_entity.uri.value)}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {# Render unified card #}
        <div class="col">
          <a href="{{ card_data.url ? card_data.url : '#' }}" class="saho-card-link" aria-label="View {{ card_data.content_type|lower }} details">
            <div class="saho-card saho-card--{{ card_data.content_type|lower|replace({' ': '-'}) }}">

              {# Card Image Area #}
              <div class="saho-card-image">
                {% if card_data.image_url %}
                  <img src="{{ card_data.image_url }}" alt="{{ card_data.title }}" class="saho-card-image__img">
                {% else %}
                  <div class="saho-card-image--placeholder">
                    {% set icon = placeholder_icons[card_data.content_type] ?? placeholder_icons.default %}
                    <i class="fas {{ icon }}"></i>
                  </div>
                {% endif %}

                {# Card Badge #}
                <div class="saho-card-badge">{{ card_data.content_type }}</div>
              </div>

              {# Card Content #}
              <div class="saho-card-content">
                {# Title #}
                <div class="saho-card-title">
                  {{ card_data.title ? card_data.title : (card_data.content_type ~ ' Item') }}
                </div>

                {# Date subtitle #}
                {% if card_data.date %}
                  <div class="saho-card-subtitle">{{ card_data.date }}</div>
                {% endif %}

                {# Description #}
                {% if card_data.body %}
                  <div class="saho-card-description">
                    {{ card_data.body|striptags|trim|slice(0, 150) ~ (card_data.body|striptags|trim|length > 150 ? '...' : '') }}
                  </div>
                {% endif %}

                {# Button in footer #}
                <div class="saho-card-footer">
                  <span class="saho-card-button">
                    Read more
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                    </svg>
                  </span>
                </div>
              </div>
            </div>
          </a>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
</div>
