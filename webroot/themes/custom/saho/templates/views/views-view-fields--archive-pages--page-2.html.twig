{#
/**
 * @file
 * Archive pages card display using saho-card component (page 2).
 *
 * Available variables:
 * - fields: Field objects for the current row
 * - attributes: HTML attributes for the field container
 * - row: Row data including _entity
 */
#}

{# Extract URL from title field #}
{% set entity_url = '#' %}
{% if fields.title is defined %}
  {% set content = fields.title.content %}
  {% if content matches '/<a href="([^"]+)"/' %}
    {% set matches = content|split('href="')|last|split('"') %}
    {% if matches|length > 0 %}
      {% set entity_url = matches[0] %}
    {% endif %}
  {% endif %}
{% endif %}

{# Extract title text #}
{% set title_text = '' %}
{% if fields.title is defined %}
  {% set title_text = fields.title.content|striptags|trim %}
{% endif %}

{# Determine resource type for badge #}
{% set resource_type = 'Document' %}
{% if fields.field_media_library_type is defined %}
  {% set type_text = fields.field_media_library_type.content|striptags|trim|lower %}
  {% if 'photo' in type_text or 'image' in type_text %}
    {% set resource_type = 'Photo' %}
  {% elseif 'audio' in type_text or 'sound' in type_text %}
    {% set resource_type = 'Audio' %}
  {% elseif 'video' in type_text or 'film' in type_text %}
    {% set resource_type = 'Video' %}
  {% elseif 'pdf' in type_text %}
    {% set resource_type = 'PDF' %}
  {% endif %}
{% endif %}

{# Build metadata for card #}
{% set card_metadata = {} %}
{% if fields.field_author is defined and fields.field_author.content|striptags|trim is not empty %}
  {% set card_metadata = card_metadata|merge({author: fields.field_author.content|striptags|trim}) %}
{% endif %}
{% if fields.field_publication_date_archive is defined and fields.field_publication_date_archive.content|striptags|trim is not empty %}
  {% set card_metadata = card_metadata|merge({date: fields.field_publication_date_archive.content|striptags|trim}) %}
{% elseif fields.created is defined and fields.created.content|striptags|trim is not empty %}
  {% set card_metadata = card_metadata|merge({date: fields.created.content|striptags|trim}) %}
{% endif %}
{% set card_metadata = card_metadata|merge({category: resource_type}) %}

{# Extract description #}
{% set description = '' %}
{% if fields.field_synopsis is defined and fields.field_synopsis.content|striptags|trim is not empty %}
  {% set description = fields.field_synopsis.content|striptags|trim %}
{% elseif fields.body is defined and fields.body.content|striptags|trim is not empty %}
  {% set description = fields.body.content|striptags|trim %}
{% endif %}

{# Get image URL from various possible fields #}
{% set image_url = '' %}
{% if fields.field_archive_image is defined and fields.field_archive_image.content %}
  {% set image_url = 'has_image' %}
{% elseif fields.field_article_image is defined and fields.field_article_image.content %}
  {% set image_url = 'has_image' %}
{% elseif fields.field_bio_pic is defined and fields.field_bio_pic.content %}
  {% set image_url = 'has_image' %}
{% elseif fields.field_image is defined and fields.field_image.content %}
  {% set image_url = 'has_image' %}
{% elseif fields.field_thumbnail is defined and fields.field_thumbnail.content %}
  {% set image_url = 'has_image' %}
{% endif %}

{# Get content type for styling #}
{% set content_type = 'archive' %}
{% if row and row._entity %}
  {% set content_type = row._entity.bundle() %}
{% endif %}

{# Render using saho-card component #}
{% if image_url %}
  <a href="{{ entity_url }}" class="saho-card-link" aria-label="View resource details">
    <article class="saho-card saho-card--primary saho-card--medium saho-card--type-{{ content_type|replace({'_': '-'}) }} card h-100">
      <div class="card-img-top-wrapper position-relative overflow-hidden saho-card__image">
        {% if fields.field_archive_image is defined and fields.field_archive_image.content %}
          {{ fields.field_archive_image.content }}
        {% elseif fields.field_article_image is defined and fields.field_article_image.content %}
          {{ fields.field_article_image.content }}
        {% elseif fields.field_bio_pic is defined and fields.field_bio_pic.content %}
          {{ fields.field_bio_pic.content }}
        {% elseif fields.field_image is defined and fields.field_image.content %}
          {{ fields.field_image.content }}
        {% elseif fields.field_thumbnail is defined and fields.field_thumbnail.content %}
          {{ fields.field_thumbnail.content }}
        {% endif %}

        <div class="position-absolute top-0 end-0 m-2">
          <span class="badge saho-card__type-badge">{{ resource_type }}</span>
        </div>
      </div>

      <div class="card-body d-flex flex-column saho-card__body">
        <h3 class="card-title saho-card__title">{{ title_text }}</h3>

        {% if card_metadata %}
          <div class="saho-card__meta text-muted small mb-2">
            {% if card_metadata.author %}
              <span class="saho-card__author">
                <i class="fas fa-user me-1" aria-hidden="true"></i>
                {{ card_metadata.author }}
              </span>
            {% endif %}
            {% if card_metadata.date %}
              <span class="saho-card__date {% if card_metadata.author %}ms-2{% endif %}">
                <i class="fas fa-clock me-1" aria-hidden="true"></i>
                {{ card_metadata.date }}
              </span>
            {% endif %}
          </div>
        {% endif %}

        {% if description %}
          <div class="card-text saho-card__content text-muted mb-3">
            {{ description|length > 120 ? description|slice(0, 120) ~ '...' : description }}
          </div>
        {% endif %}

        <div class="mt-auto saho-card__footer-section">
          <div class="saho-card__action mb-2">
            <span class="saho-card-button-wrapper" style="position: relative; z-index: 2;">
              <span class="saho-button saho-button--card-action saho-button--small">
                <span class="saho-button__text">View Resource</span>
                <svg class="saho-button__icon saho-button__icon--arrow-right" width="14" height="14" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                </svg>
              </span>
            </span>
          </div>
        </div>
      </div>
    </article>
  </a>
{% else %}
  {% include 'saho:saho-card' with {
    title: title_text,
    content: description,
    url: entity_url,
    content_type: content_type,
    metadata: card_metadata,
    button_text: 'View Resource',
    button_variant: 'card-action',
    button_icon: 'arrow-right'
  } %}
{% endif %}
